"""
Review Summarizer Node
"""
import json
from datetime import datetime

from loguru import logger

from app.reviewer.state import ReviewState
from app.reviewer.prompts import create_summary_prompt
from app.reviewer.llm import get_llm
from app.reviewer.utils import parse_llm_json_response


async def summarize_review(state: ReviewState) -> dict:
    """
    ëª¨ë“  ë¦¬ë·°ë¥¼ ì¢…í•©í•˜ì—¬ ìµœì¢… ì½”ë©˜íŠ¸ë¥¼ ìƒì„±í•˜ëŠ” ë…¸ë“œ

    Args:
        state: í˜„ì¬ ë¦¬ë·° ìƒíƒœ

    Returns:
        ì—…ë°ì´íŠ¸ëœ ìƒíƒœ (final_review, review_decision ì¶”ê°€)
    """
    logger.info("ğŸ“ ìµœì¢… ë¦¬ë·° ìš”ì•½ ì‹œì‘...")

    pr_data = state["pr_data"]
    pr_intent = state.get("pr_intent", {})
    risk_assessment = state.get("risk_assessment", {})
    file_reviews = state.get("file_reviews", [])

    logger.info(f"ì´ {len(file_reviews)}ê°œ íŒŒì¼ ë¦¬ë·° ê²°ê³¼ë¥¼ ì¢…í•© ì¤‘...")

    try:
        # LLM ì´ˆê¸°í™” (Providerì— ë”°ë¼ ìë™ ì„ íƒ)
        llm = get_llm(temperature=0.1)  # ì•½ê°„ì˜ ì°½ì˜ì„± í—ˆìš©

        # í”„ë¡¬í”„íŠ¸ ìƒì„±
        prompt = create_summary_prompt(pr_data, pr_intent, risk_assessment, file_reviews)

        # LLM í˜¸ì¶œ
        response = await llm.ainvoke(prompt)
        response_text = response.content

        logger.debug(f"Summary ì‘ë‹µ: {response_text[:200]}...")

        # JSON íŒŒì‹±
        try:
            summary = parse_llm_json_response(response_text)

            decision = summary.get("decision", "COMMENT")
            final_comment = summary.get("comment", response_text)

            logger.info(f"âœ… ìµœì¢… ë¦¬ë·° ì™„ë£Œ: {decision}")
            logger.debug(f"ë¦¬ë·° ì½”ë©˜íŠ¸ ê¸¸ì´: {len(final_comment)} ì")

        except json.JSONDecodeError as e:
            logger.error(f"JSON íŒŒì‹± ì‹¤íŒ¨, ì›ë³¸ í…ìŠ¤íŠ¸ ì‚¬ìš©: {e}")
            decision = "COMMENT"
            final_comment = response_text

        return {
            "final_review": final_comment,
            "review_decision": decision,
            "messages": [{
                "role": "summarizer",
                "content": response_text,
                "timestamp": datetime.now().isoformat()
            }]
        }

    except Exception as e:
        logger.error(f"âŒ ë¦¬ë·° ìš”ì•½ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")

        # í´ë°±: ê°„ë‹¨í•œ ìš”ì•½ ìƒì„±
        fallback_comment = f"""## ğŸ¤– AI ì½”ë“œ ë¦¬ë·°

### âš ï¸ ë¦¬ë·° ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ

ë¦¬ë·°ë¥¼ ì™„ì „íˆ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: {str(e)}

### ğŸ“Š ê¸°ë³¸ ì •ë³´
- PR: {pr_data.title}
- íŒŒì¼: {pr_data.changed_files_count}ê°œ
- ë³€ê²½: +{pr_data.total_additions}/-{pr_data.total_deletions}
- ë¦¬ë·°ëœ íŒŒì¼: {len(file_reviews)}ê°œ

---
*ğŸ¤– Generated by Almagest Reviewer*
"""

        return {
            "final_review": fallback_comment,
            "review_decision": "COMMENT",
            "errors": [f"Summary generation failed: {str(e)}"]
        }
