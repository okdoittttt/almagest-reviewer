"""
Review Summary Prompt
"""
from app.models import PRData


def create_summary_prompt(
    pr_data: PRData,
    pr_intent: dict,
    risk_assessment: dict,
    file_reviews: list[dict]
) -> str:
    """
    ìµœì¢… ë¦¬ë·° ìš”ì•½ì„ ìƒì„±í•˜ëŠ” í”„ë¡¬í”„íŠ¸

    Args:
        pr_data: PR ë°ì´í„°
        pr_intent: PR ì˜ë„ ë¶„ì„ ê²°ê³¼
        risk_assessment: ìœ„í—˜ë„ í‰ê°€ ê²°ê³¼
        file_reviews: íŒŒì¼ë³„ ë¦¬ë·° ê²°ê³¼ ëª©ë¡

    Returns:
        í”„ë¡¬í”„íŠ¸ ë¬¸ìì—´
    """
    # ì´ìŠˆ ì§‘ê³„
    all_issues = []
    blocking_count = 0
    needs_changes_count = 0
    minor_issues_count = 0
    lgtm_count = 0

    for review in file_reviews:
        status = review.get('status', 'UNKNOWN')
        if status == 'BLOCKING':
            blocking_count += 1
        elif status == 'NEEDS_CHANGES':
            needs_changes_count += 1
        elif status == 'MINOR_ISSUES':
            minor_issues_count += 1
        elif status == 'LGTM':
            lgtm_count += 1

        for issue in review.get('issues', []):
            all_issues.append({
                'file': review['filename'],
                'severity': issue.get('severity', 'unknown'),
                'type': issue.get('type', 'unknown'),
                'message': issue.get('message', ''),
                'suggestion': issue.get('suggestion', '')
            })

    # ì‹¬ê°ë„ë³„ ì´ìŠˆ ë¶„ë¥˜
    high_issues = [i for i in all_issues if i['severity'] == 'high']
    medium_issues = [i for i in all_issues if i['severity'] == 'medium']
    low_issues = [i for i in all_issues if i['severity'] == 'low']

    # íŒŒì¼ë³„ ë¦¬ë·° ìš”ì•½
    file_summaries = []
    for review in file_reviews[:10]:  # ìµœëŒ€ 10ê°œë§Œ
        file_summaries.append(f"""
**{review['filename']}** ({review.get('status', 'UNKNOWN')})
- ì´ìŠˆ: {len(review.get('issues', []))}ê°œ
- ìš”ì•½: {review.get('summary', 'N/A')}
""")

    return f"""ë‹¹ì‹ ì€ íŒ€ ë¦¬ë“œ ê°œë°œìë¡œì„œ ëª¨ë“  íŒŒì¼ ë¦¬ë·°ë¥¼ ì¢…í•©í•˜ì—¬ ìµœì¢… ì˜ê²¬ì„ ì‘ì„±í•©ë‹ˆë‹¤.

## PR ê°œìš”
**ì œëª©:** {pr_data.title}
**ì‘ì„±ì:** @{pr_data.author.login}
**ì˜ë„:** {pr_intent.get('summary', 'N/A')} ({pr_intent.get('type', 'unknown')})
**ìœ„í—˜ë„:** {risk_assessment.get('level', 'UNKNOWN')} ({risk_assessment.get('score', 0)}/10)

## ë³€ê²½ í†µê³„
- íŒŒì¼: {pr_data.changed_files_count}ê°œ
- ë³€ê²½ëŸ‰: +{pr_data.total_additions}/-{pr_data.total_deletions} ì¤„
- ì»¤ë°‹: {pr_data.commits_count}ê°œ

## ë¦¬ë·° ê²°ê³¼ ì§‘ê³„
- âœ… LGTM: {lgtm_count}ê°œ íŒŒì¼
- âš ï¸ MINOR_ISSUES: {minor_issues_count}ê°œ íŒŒì¼
- ğŸ”§ NEEDS_CHANGES: {needs_changes_count}ê°œ íŒŒì¼
- ğŸš« BLOCKING: {blocking_count}ê°œ íŒŒì¼

## ì‹¬ê°ë„ë³„ ì´ìŠˆ
- ğŸ”´ HIGH: {len(high_issues)}ê°œ
- ğŸŸ¡ MEDIUM: {len(medium_issues)}ê°œ
- ğŸŸ¢ LOW: {len(low_issues)}ê°œ

## ì£¼ìš” ì´ìŠˆ ëª©ë¡
{chr(10).join([
    f"- [{i['severity'].upper()}] {i['file']}: {i['message']}"
    for i in (high_issues + medium_issues)[:5]
]) if (high_issues + medium_issues) else "(ì‹¬ê°í•œ ì´ìŠˆ ì—†ìŒ)"}

## íŒŒì¼ë³„ ë¦¬ë·° ìš”ì•½
{chr(10).join(file_summaries) if file_summaries else "(ë¦¬ë·° ì—†ìŒ)"}

---

ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ **GitHub PRì— ê²Œì‹œí•  ìµœì¢… ë¦¬ë·° ì½”ë©˜íŠ¸**ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ JSON ì‘ë‹µí•´ì£¼ì„¸ìš”:

```json
{{
  "decision": "APPROVE | REQUEST_CHANGES | COMMENT",
  "summary": "ì „ì²´ í‰ê°€ë¥¼ 2-3ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½",
  "comment": "ì‹¤ì œ GitHubì— ê²Œì‹œë  ë§ˆí¬ë‹¤ìš´ ì½”ë©˜íŠ¸ (ì•„ë˜ í˜•ì‹ ì°¸ê³ )",
  "action_items": [
    "ìˆ˜ì •ì´ í•„ìš”í•œ í•­ëª© 1",
    "ìˆ˜ì •ì´ í•„ìš”í•œ í•­ëª© 2"
  ]
}}
```

**comment í•„ë“œëŠ” ë‹¤ìŒ ë§ˆí¬ë‹¤ìš´ í˜•ì‹ì„ ë”°ë¼ì£¼ì„¸ìš”:**

```markdown
## ğŸ¤– AI ì½”ë“œ ë¦¬ë·°

### ğŸ“‹ ìš”ì•½
[ì „ì²´ í‰ê°€ ìš”ì•½]

### âœ… ì˜ëœ ì 
- [ê¸ì •ì ì¸ ë¶€ë¶„ 1]
- [ê¸ì •ì ì¸ ë¶€ë¶„ 2]

### âš ï¸ ì£¼ìš” ì´ìŠˆ
#### ğŸ”´ High Priority
1. **[íŒŒì¼ëª…]**: [ë¬¸ì œ ì„¤ëª…]
   - ì œì•ˆ: [í•´ê²° ë°©ë²•]

#### ğŸŸ¡ Medium Priority
1. **[íŒŒì¼ëª…]**: [ë¬¸ì œ ì„¤ëª…]

### ğŸ’¡ ì œì•ˆì‚¬í•­
- [ê°œì„  ì œì•ˆ 1]
- [ê°œì„  ì œì•ˆ 2]

### ğŸ¯ ê²°ë¡ 
[ìµœì¢… íŒë‹¨ ë° ë‹¤ìŒ ë‹¨ê³„]

---
*ğŸ¤– Generated by Almagest Reviewer*
```

**decision ê¸°ì¤€:**
- **APPROVE**: ì´ìŠˆê°€ ì—†ê±°ë‚˜ ëª¨ë‘ low severity, ë¨¸ì§€ ê°€ëŠ¥
- **REQUEST_CHANGES**: high severity ì´ìŠˆê°€ ìˆê±°ë‚˜ blocking íŒŒì¼ì´ ìˆìŒ
- **COMMENT**: medium ì´í•˜ ì´ìŠˆë§Œ ìˆì§€ë§Œ ì˜ê²¬ì„ ë‚¨ê¹€

JSONë§Œ ì‘ë‹µí•´ì£¼ì„¸ìš”."""
